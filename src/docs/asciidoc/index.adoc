= Comment j'ai rendu ma maison moins bête
:source-highlighter: prettify
:icons: font
//gitlab icon is in 4.6
:iconfont-cdn: https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.0/css/font-awesome.min.css

:!sectids:
:!hardbreaks:
:stem:
:imagesdir: ./images/
:imagesoutdir: {basedir}/src/docs/images/
:author: Cedric Gatay
:date: 2018-03-27

include::banner.adoc[]

== Un peu d'histoire

[.cue]
****
J'ai, il y a deux ans, changé de domicile pour une maison. 
Dans l'appartement que je possédais auparavant, j'avais eu envie d'automatiser certaines choses mais je n'avais pas mis en pratique.
L’acquisition et le déménagement dans un lieu ou je suis censé passer plus de temps m’a un peu plus motivé.
Je vais essayer de vous decrire mon parcours et par quelles étapes je suis passé.
****


== image:CG_BW.jpg[]

icon:twitter[] @Cedric_Gatay

icon:code[] Developer

icon:empire[] Code-Troopers co-founder

icon:google[] GDG Tours lead

image:tnt_logo.png[role=small] TouraineTech co-organizer

== icon:code-fork[]

 * icon:bus[] http://navigtours.com[Navig'Tours] icon:apple[] icon:android[]
 * icon:music[] Chapi.to icon:apple[] icon:android[]
 * icon:github[] FOSS:
 ** icon:calendar[] Android Betterpickers icon:android[]
 ** icon:github-alt[] sbt plugins icon:globe[]
 ** icon:github-alt[] wicket-hot-reload icon:globe[]
 ** icon:gitlab[] Gitlab contributor icon:globe[]

[.cue]
****
One can also notice various Wicket framework contributions, docker images, jenkins plugins, restx, parsley.js bridges...
****

== 1 433Mhz

== 2 Zwave

== 3 youhou toutes les techno

== 4 assistant


== Mode dégradé

[.cue]
****
Bien qu'on ait souvent notre Smartphone en main ou pas loin, il n'est pas toujours rapide de l'utiliser.
S’il faut lire un manuel pour allumer la lumière du salon, on a un problème.
Il faut donc bien penser à un mode sans smartphone, sans internet et sans box domotique accessible.
****

== Des essais de logiciels

[.cue]
****
* openhab
* Jeedom
* Domoticz
* Home assistant
****

== Migration de solution

[.cue]
****
J'étais dans une situation où j’avais besoin d’être en version instable (master quoi) de domoticz : xiaomi tout nouvellement supporté, changement dans Harmony … Du coup j'ai joué un peu et * faute de build automatique d'image Docker de master, je l'ai mis en place (et il y a des trucs marrant non documentés dans hub.docker.com pour trigger des builds cf repo github)
C'était pas hyper confortable ni sécurisant, j'ai donc repris mes investigations pour trouver une alternative. Avec un peu plus de maturité sur mes besoins, j'ai essayé des solutions plus actives, avec plus de composants supportés et en bonus, un gui sympa. Ce qui m'a amené à retester et adopter Home assistant. 
Ceci étant dit, mon build automatique est toujours vivant et est une image très utilisée (100k pull…)
****

== C'est parti pour la migration

[.cue]
****
Qu'est ce que je perd :

* Historique des éléments (températures, hygrométrie, temps d'utilisation)
* Une interface simple côté administration
* Un logiciel éprouvé
* Des automatisations

Qu'est ce que je gagne :
* Je n’utilise plus master
* Le support de plus de composants
* Un GUI sympa
* La configuration dans des fichiers à plat (bon c'est quand même du yml)
****

== Problème zwave

[.cue]
****
Changement du Synology vers un pi
Changement de domoticz vers Home assistant en passant par jeedom
Découverte de difficulté sur la portée réseau
Firmware fibaro bancal
****

== Lenteurs

[.cue]
****
Toutes les technologies ne permettent pas de faire autrement que du polling
Réseau domestique bien occupé
Routeur performant conseillé (pb Samsung ssid, blocage de l’outbound, segment réseau à part)
****

== Cas d’utilisation

[.cue]
****
Allumage des lumières lorsque je sors de mon garage
Alerte de porte restée ouverte (garage / baie vitrée / entrée…)
Extinction globale des éléments du salon (scenario dodo)
Activation du mode absent automatique (alerte d’ouverture de porte, extinction musique / lumières…)
Alerte de fin de lessive (pour ne pas oublier de la sortir et de la transférer dans le sèche linge)
****

== Automatiser mais pas trop

[.cue]
****
Un des trucs marrants quand on tente d'automatiser c'est qu'on a tendance à oublier pas mal de conditions.
Exemple : allumer toutes les lampes lorsqu'une est allumée dans la pièce, j’en éteins une manuellement, oups elle se rallume : il faut prendre en compte l’historique récent.
Par contre on peut assez facilement envisager de passer les lumières du salon en mode “cinéma” lorsque la télé est allumée et qu'on est après le coucher du soleil. Par contre attention de ne pas allumer les lumières si elles ne l’étaient pas (ou être conscient que ça peut arriver).
J’éteins une lampe d’un scenario, il ne faut pas qu’elle se rallume sur l’action d’un scenario (effet mémoire temporaire)
****

== En vrac des technologies utilisées

* RfxTrx
* ZWave 
* Ikea Trafri
* Philips Hue
* Xiaomi Home
* Dash button
* Netatmo weather
* Logitech Harmony
* Spotify connect
* Yamaha
* Samsung TV | Wash
* Dialogflow
* Home-Assistant
* Google home
* Facebook Messenger
* Slack
* Apple Homekit
* Amazon Dash button
* Google Chromecast
* Synology Surveillance Station
* Synology DSM
* Somfy RTS
* AsusWRT
* IFTTT
* Syncthing

== Démo Time

[.cue]
****
Montrer le démarrage de Hass
La simplicité d'installation via pip
Montrer le fichier de configuration et booter le gui avec du zwave et du rfxtrx (prise commandée, température), zwave avec prise fibaro, capteur de porte.

Écrire une automatisation, TODO

Faire un exemple dialogflow (vérifier ngrok, reverse tunnel, whatever), et slack
****

[.bibliography]
https://www.youtube.com/watch?v=OZyzfnZVCCk Black Mirror Clip from White Christmas Episode
https://www.youtube.com/watch?v=sXH2K2ZlrjQ Iron Man's Alarm Clock(scene from movie)
